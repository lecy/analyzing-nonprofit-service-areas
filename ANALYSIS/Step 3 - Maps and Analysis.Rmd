---
title: "Maps and Analysis"
author: "Matt McKnight"
date: "May 11, 2017"
output:
  html_document:
    df_print: paged
    keep_md: true
    theme: cerulean
    highlight: haddock
    toc: yes
    toc_float: yes
    code_fold: hide
  pdf_document: default
---


```{r setup, include=FALSE}

# global chunk options
knitr::opts_chunk$set(echo = TRUE, warning=F, message=F, fig.width=10)

library( ggmap )
library( rgdal )
library( devtools )
library( censusapi )
library( plyr )
library( gdata )
library( geojsonio )
library( acs )
library( tigris )
library( sf ) 
library( sp )  
library( rgeos )
library( spatialEco ) 
library( leaflet )
library( raster )
library( repmis )
library( TSP )
library( magrittr )
library( lattice )
library( GISTools )

```


# MAPS

## Load in Census Shapefiles from GitHub

### Note: To see how these shapefiles were created, check [Shapefiles to Geojson Files](Shapefiles_to_Geojson_Files.hmtl) HTML file  for more information.


```{r}

file.url <- "https://raw.githubusercontent.com/lecy/analyzing-nonprofit-service-areas/master/SHAPEFILES/syr_merged.geojson"

syr <- geojson_read( file.url, method="local", what="sp")

spTransform(syr, CRS("+proj=longlat +datum=WGS84"))

file.url <- "https://raw.githubusercontent.com/lecy/analyzing-nonprofit-service-areas/master/SHAPEFILES/syr_merged_cen.geojson"

centroids <- geojson_read( file.url, method="local", what="sp")

spTransform(centroids, CRS("+proj=longlat +datum=WGS84"))

file.url <- "https://raw.githubusercontent.com/lecy/analyzing-nonprofit-service-areas/master/SHAPEFILES/pov_orgs.geojson"

pov_orgs <- geojson_read( file.url, method="local", what="sp")

spTransform(pov_orgs, CRS("+proj=longlat +datum=WGS84"))

par( mar=c(0,0,0,0) )  # drop plot margins

```


##Check shapefiles with plots

```{r}

plot( syr )
plot( centroids, col="black", pch = 20, add = T)

plot( syr )
plot( centroids, col="black", pch = 20, add = T )
plot( pov_orgs, col="red", lwd = 2, add = T )

names(syr)

```


### Create zoom enabled map of Syracuse, NY

```{r}
map <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-76.1474244, lat=43.0481221, popup="Downtown Syracuse, NY")

map %>% addProviderTiles(providers$CartoDB)


```

### Set the view of the Syracuse MSA

```{r}



syr_map <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addTiles() %>% setView(-76.1474244, 43.0481221, zoom = 9) %>%
  addMarkers(lng=-76.1474244, lat=43.0481221, popup="Downtown Syracuse, NY") %>%
  addPolygons(data = syr, fillOpacity = 0.3) %>%
  addCircles(data = pov_orgs) %>%
  addCircles(data = centroids)

syr_map %>% addProviderTiles(providers$CartoDB)  


              
```

### Edit color format of polygons and data points

```{r}


syr_map <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addTiles() %>% setView(-76.1474244, 43.0481221, zoom = 9) %>%
  addMarkers(lng=-76.1474244, lat=43.0481221, popup="Downtown Syracuse, NY") %>%
  addPolygons(data = syr, fillOpacity = 0.3, weight = 2) %>%
  addCircles(data = pov_orgs, color= "red", opacity = 1.0) %>%
  addCircles(data = centroids, color= "black", opacity = 1.0)

syr_map %>% addProviderTiles(providers$CartoDB)  

```

### Adding census tract information to map

```{r}

# change variables to be numeric

syr$porp_white <- as.numeric(as.character(syr$porp_white))
syr$porp_m <- as.numeric(as.character(syr$porp_m))
syr$mhh_income <- as.numeric(as.character(syr$mhh_income))
class(syr$porp_m)
class(syr$porp_white)
class(syr$mhh_income)

# By race

pal <- colorNumeric(
  palette = "Blues",
  domain = syr$porp_m )


syr_map <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addTiles() %>% setView(-76.1474244, 43.0481221, zoom = 9) %>%
  addMarkers(lng=-76.1474244, lat=43.0481221, popup="Downtown Syracuse, NY") %>%
  addPolygons(data = syr, fillOpacity = 0.3, weight = 2,
              color = ~pal(syr$porp_m)) %>%
  addCircles(data = pov_orgs, color= "red", opacity = 1.0) %>%
  addCircles(data = centroids, color= "black", opacity = 1.0) 


syr_map %>% addProviderTiles(providers$CartoDB)


# By Income level

pal2 <- colorNumeric(
  palette = "Blues",
  domain = syr$mhh_income )


syr_map2 <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addTiles() %>% setView(-76.1474244, 43.0481221, zoom = 9) %>%
  addMarkers(lng=-76.1474244, lat=43.0481221, popup="Downtown Syracuse, NY") %>%
  addPolygons(data = syr, fillOpacity = 0.3, weight = 2,
              color = ~pal2(syr$mhh_income)) %>%
  addCircles(data = pov_orgs, color= "red", opacity = 1.0) %>%
  addCircles(data = centroids, color= "black", opacity = 1.0) 


syr_map2 %>% addProviderTiles(providers$CartoDB)


```

# ANALYSIS

## Create Service Catchment Areas


```{r eval=FALSE}


# Create buffer, calculate number of nonprofit points around centroids

centroids_buff <- gBuffer(spgeom = centroids, width = .024, joinStyle="ROUND",                             byid = T)
centroids_buff@proj4string
spTransform(centroids_buff, CRS("+proj=longlat +datum=WGS84"))

org_buff <- gBuffer(spgeom = pov_orgs, width = .024, joinStyle="ROUND",                             byid = T)
centroids_buff@proj4string
spTransform(org_buff, CRS("+proj=longlat +datum=WGS84"))

spTransform(syr, CRS("+proj=longlat +datum=WGS84"))


# join data to centroid buffers
centroids_buff$ID <- c(1:186)
syr$ID <- c(1:186)
org_buff$ID <- c(1:1095)
pov_orgs$ID <- c(1:1095)

test <- merge( centroids_buff, syr@data, "ID", "ID" )
test2 <- merge( org_buff, pov_orgs@data, "ID", "ID" )

# Run an overlay

CRS.new<-CRS("+proj=longlat +datum=WGS84")
proj4string(test) <- CRS.new 
proj4string(pov_orgs) <- CRS.new

over2 <- over(pov_orgs, test) 

syr$output <- table(over$tract)

# Alternate
library(GISTools)

# Number of nonprofits within a 1.5 miles of middle of census tract.
res <- poly.counts(pov_orgs, test)
setNames(res, test$tract)
syr$output2 <- setNames(res, test$tract)

# Number of nonprofits in each census tract
res <- poly.counts(pov_orgs, syr)
setNames(res, syr$tract)
syr$output3 <- setNames(res, syr$tract)

# Org way:
# Number of nonprofit service catchment areas within a given census tract


bg_num <- 1*bg
 
 
point.in.poly


# other option?
# syr$test <- 1:nrow(over_clean)

plot(syr) %>%
plot(centroids_buff) 
points( pov_orgs, col="darkorange4", pch= 20 )


# Centroid buffer example
syr_map2 <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addTiles() %>% setView(-76.1474244, 43.0481221, zoom = 9) %>%
  addMarkers(lng=-76.1474244, lat=43.0481221, popup="Downtown Syracuse, NY") %>%
  addPolygons(data = syr, fillOpacity = 0, weight = 2) %>%
  addCircles(data = pov_orgs, color= "red", opacity = 1.0) %>%
  addPolygons(data = centroids_buff, fillOpacity = 0.3, weight = 2)
             
syr_map2 %>% addProviderTiles(providers$CartoDB)

# org_buff example
syr_map2 <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addTiles() %>% setView(-76.1474244, 43.0481221, zoom = 9) %>%
  addMarkers(lng=-76.1474244, lat=43.0481221, popup="Downtown Syracuse, NY") %>%
  addPolygons(data = syr, fillOpacity = 0, weight = 2) %>%
  addPolygons(data = org_buff, color= "red", fillOpacity = 0.3, weight = 2)
             
syr_map2 %>% addProviderTiles(providers$CartoDB)

# Similar to above, but combines over and removing NAs into one step
# pov_orgs_t <- pov_orgs 
# pov_orgs_t$test <- pov_orgs[centroids_buff,]
```

### Analysis continued 

```{r}
# Poportion of census tract that are high/low diversity
  # number of nonprofits by type in high/low racially diverse areas
  # number of nonprofits by type in low/high income census tracts


# Corr analysis between nonprofit access and census tract attributes
  # Number of nonprofits location by census tract income or race
    # Race
    # Income




xyplot(output2 ~ porp_white, data = syr@data)
xyplot(output2 ~ mhh_income, data = syr@data)

```


## Final section: Account for all urban census tracts in 25 cities


```{R}


```

